<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Listening Dashboard - Last 7 Days</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(29, 185, 84, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        h1 {
            color: #1db954;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(29, 185, 84, 0.3);
        }

        .subtitle {
            color: #b3b3b3;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(29, 185, 84, 0.2), 0 0 0 1px rgba(29, 185, 84, 0.2);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1db954;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(29, 185, 84, 0.5);
        }

        .stat-label {
            color: #b3b3b3;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(29, 185, 84, 0.15), 0 0 0 1px rgba(29, 185, 84, 0.15);
        }

        .chart-title {
            font-size: 1.5em;
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .table-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .table-title {
            font-size: 1.5em;
            color: #ffffff;
            margin-bottom: 20px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
            color: #000000;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        td {
            color: #e0e0e0;
        }

        tr:hover {
            background-color: rgba(29, 185, 84, 0.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #1db954;
            font-size: 1.2em;
        }

        .error {
            background: linear-gradient(135deg, #2d1a1a 0%, #3d2d2d 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3), 0 0 0 1px rgba(211, 47, 47, 0.2);
            text-align: center;
            color: #ff6b6b;
            font-size: 1.1em;
            border: 1px solid rgba(211, 47, 47, 0.3);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽµ Spotify Listening Dashboard</h1>
            <p class="subtitle">Your Last 7 Days of Music</p>
        </header>

        <div id="loading" class="loading">Loading your listening data...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-tracks">0</div>
                    <div class="stat-label">Total Plays</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unique-tracks">0</div>
                    <div class="stat-label">Unique Tracks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unique-artists">0</div>
                    <div class="stat-label">Unique Artists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-popularity">0</div>
                    <div class="stat-label">Avg Popularity</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Top Tracks</div>
                    <div class="chart-wrapper">
                        <canvas id="tracksChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Top Artists</div>
                    <div class="chart-wrapper">
                        <canvas id="artistsChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Genre Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="genresChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Listening Activity</div>
                    <div class="chart-wrapper">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-title">Recent Plays</div>
                <div style="overflow-x: auto;">
                    <table id="tracksTable">
                        <thead>
                            <tr>
                                <th>Track</th>
                                <th>Artist</th>
                                <th>Album</th>
                                <th>Genres</th>
                                <th>Popularity</th>
                                <th>Played At</th>
                            </tr>
                        </thead>
                        <tbody id="tracksTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tracksChart, artistsChart, genresChart, activityChart;

        async function loadDashboard() {
            try {
                // Load stats
                const statsResponse = await fetch('/api/stats');
                if (!statsResponse.ok) {
                    const errorData = await statsResponse.json();
                    throw new Error(errorData.error || 'Failed to load statistics');
                }
                const stats = await statsResponse.json();

                // Load data
                const dataResponse = await fetch('/api/data');
                if (!dataResponse.ok) {
                    const errorData = await dataResponse.json();
                    throw new Error(errorData.error || 'Failed to load data');
                }
                const dataResult = await dataResponse.json();

                // Update stats
                document.getElementById('total-tracks').textContent = dataResult.total_tracks || 0;
                document.getElementById('unique-tracks').textContent = stats.unique_tracks || 0;
                document.getElementById('unique-artists').textContent = stats.unique_artists || 0;
                document.getElementById('avg-popularity').textContent = stats.avg_popularity || 0;

                // Create charts
                createTracksChart(stats.top_tracks);
                createArtistsChart(stats.top_artists);
                createGenresChart(stats.genres);
                createActivityChart(stats.daily_activity);

                // Populate table
                populateTable(dataResult.data);

                // Show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        function createTracksChart(data) {
            const ctx = document.getElementById('tracksChart').getContext('2d');
            const labels = data.map(item => `${item.Track} - ${item.Artist}`).slice(0, 10);
            const counts = data.map(item => item['Play Count']).slice(0, 10);

            if (tracksChart) tracksChart.destroy();

            tracksChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Play Count',
                        data: counts,
                        backgroundColor: '#1db954',
                        borderColor: '#1ed760',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#b3b3b3'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                color: '#b3b3b3'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createArtistsChart(data) {
            const ctx = document.getElementById('artistsChart').getContext('2d');
            const labels = data.map(item => item.Artist).slice(0, 10);
            const counts = data.map(item => item['Play Count']).slice(0, 10);

            if (artistsChart) artistsChart.destroy();

            artistsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#1db954', '#1ed760', '#ff6b6b', '#4ecdc4',
                            '#45b7d1', '#96ceb4', '#ffeaa7', '#dda15e',
                            '#bc6c25', '#ffa07a'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#b3b3b3'
                            }
                        }
                    }
                }
            });
        }

        function createGenresChart(data) {
            const ctx = document.getElementById('genresChart').getContext('2d');
            const labels = data.map(item => item.Genre).slice(0, 10);
            const counts = data.map(item => item.Count).slice(0, 10);

            if (genresChart) genresChart.destroy();

            genresChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#1db954', '#ff6b6b', '#4ecdc4', '#45b7d1',
                            '#96ceb4', '#ffeaa7', '#dda15e', '#bc6c25',
                            '#ffa07a', '#98d8c8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#b3b3b3'
                            }
                        }
                    }
                }
            });
        }

        function createActivityChart(data) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            const labels = data.map(item => new Date(item.Date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
            const counts = data.map(item => item.Count);

            if (activityChart) activityChart.destroy();

            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Plays',
                        data: counts,
                        borderColor: '#1db954',
                        backgroundColor: 'rgba(29, 185, 84, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#1db954',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#b3b3b3'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#b3b3b3'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function populateTable(data) {
            const tbody = document.getElementById('tracksTableBody');
            tbody.innerHTML = '';

            // Sort by most recent first
            const sortedData = [...data].sort((a, b) => new Date(b['Played At']) - new Date(a['Played At']));

            sortedData.forEach(track => {
                const row = document.createElement('tr');
                const playedAt = new Date(track['Played At']).toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                row.innerHTML = `
                    <td><strong>${track.Track}</strong></td>
                    <td>${track.Artist}</td>
                    <td>${track.Album}</td>
                    <td>${track.Genres || 'N/A'}</td>
                    <td>${track.Popularity}</td>
                    <td>${playedAt}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>